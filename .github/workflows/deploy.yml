name: deploy-stacks.yml
on:
  push:
    branches:
      - 'main'
jobs:
  create-change-sets-and-deploy:
    permissions:
      id-token: write
      contents: read
      issues: write
    env:
      PYTHON_VERSION: 3.12
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install AWS CDK
        run: npm install -g aws-cdk

      - name: Install Pipenv and Dependencies
        run: |
          python -m pip install --upgrade pipenv==2026.0.3 wheel
          pipenv install --deploy --dev

      - id: get_approvers
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          result-encoding: json
          script: |
            const collaborators = await github.paginate(
              github.rest.repos.listCollaborators,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                affiliation: 'direct',
                per_page: 100
              }
            );
            const maintainers = collaborators.filter(c => c.permissions.maintain).map(c => c.login);
            return maintainers;

      - name: Configure beta deployment credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.BETA_DEPLOYMENT_ROLE }}
          aws-region: 'us-east-1'

      - name: Create beta change-set for approval
        id: beta_stack_diff
        run: |
          pipenv run cdk diff -c ENVIRONMENT=dev | sed -E 's/[0-9]{12}/[MASKED]/g' > beta_diff.txt

          DIFF_SIZE=$(wc -c < beta_diff.txt)
          if [ $DIFF_SIZE -gt 40000 ]; then
            echo "diff_summary=Large changeset detected (${DIFF_SIZE} bytes). Full diff available in workflow artifacts." >> $GITHUB_OUTPUT
          else
            echo "diff_summary<<EOF" >> $GITHUB_OUTPUT
            cat beta_diff.txt >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Upload beta diff as artifact
        uses: actions/upload-artifact@v6
        with:
          name: beta-stack-diff
          path: beta_diff.txt
          retention-days: 30

      - name: Approve or Deny beta change set
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ secrets.GITHUB_TOKEN }}
          approvers: ${{ join(fromJSON(steps.get_approvers.outputs.result), ', ') }}
          minimum-approvals: 1
          issue-title: 'Request to approve/deny Beta OSCAR Stack Deployment'
          issue-body: |
            ## Beta Stack Deployment Request

            **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            <details>
            <summary>Beta Stack Changeset Details</summary>

            ```
            ${{ steps.beta_stack_diff.outputs.diff_summary }}
            ```

            ðŸ“Ž **Full diff available in workflow artifacts:** [beta-stack-diff](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            </details>

      - name: Deploy beta stacks
        run: pipenv run cdk deploy "*" --require-approval=never -c ENVIRONMENT=dev